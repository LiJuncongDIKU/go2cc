# 包管理工具

## npm 的现状与定位
### 改进
+ 扁平化依赖树，加速依赖之间的查找
+ 使用了全局缓存，但使用文件复制的模式
+ 对 `Monorepo` 也做了原生支持
+ 锁文件也记录了精确的版本
+ 总得来说是适合中小型项目或者初学者学习基础。

## yarn
### 1.x
+ 并行安装：同时处理多个包的下载和安装，大幅提升速度。
+ `yarn.lock` 扁平化记录依赖，相较于 `npm` 的嵌套更优，且可以合并相同包相同范围声明的记录。
+ 离线缓存：首次安装的包会被缓存到本地`（~/.yarn/cache）`，后续安装可直接复用，无需重复下载。
+ 安全校验：通过 `SHA-1` 哈希验证包完整性，防止恶意包篡改。

### 2.x
+ 引入 `Plug'n'Play（PnP）`模式：取消 `node_modules` 目录，拦截 `node.js` 对包的遍历； 通过全局缓存 + `.pnp.cjs` 文件映射包路径，
+ 引入插件系统：允许通过插件扩展功能（如 @yarnpkg/plugin-typescript 支持 TypeScript 路径解析）。
+ 引入标识符概念：`.lock` 文件直接记录唯一确定的包版本，与 `package.json` 中的范围区别
+ *零安装（Zero-Installs）：将缓存的依赖包提交到 Git 仓库，新克隆项目可直接运行，无需 yarn install。* 会有一个`.gz` 文件被反复提交 `git`；感觉这个设计一般般
+ 更严格的依赖管理：默认禁止访问未在 `package.json` 中声明的依赖，避免隐式依赖问题。
> 幽灵依赖（隐式依赖），如项目声明依赖A包，A依赖B包，而项目没有直接声明B包；但因为`node_modules`中确实存在B包，项目代码中可以访问。
+ 工作区增强：原生支持 monorepo 项目，集中到多包项目的根目录下实现跨包依赖管理，跨包引用，支持 yarn workspace 命令批处理。
> 工作区和`monorepo`项目：一个前端项目包含多个关联包，例如 `@my-org/ui（UI 组件库）`、`@my-org/utils（工具函数）`、`@my-org/app（主应用）`，其中主应用依赖于组件库和工具函数。在开发时，存在`node_modules`管理繁琐、本地子包版本和在线版本调试切换问题。
  
### 3.x
+ 性能提升：PnP 模式的路径解析速度进一步优化，大型项目启动更快。
+ “混合模式”：可同时使用 `PnP` 和传统 `node_modules`。更好地兼容 `Webpack`、`Babel` 等工具链，减少 `PnP` 模式下的配置问题。*更像是一种妥协，如果实际使用混合模式可能有些奇怪*
+ `yarn dlx`临时下载并执行包对标 `npx`
+ 依赖约束：通过 `packageExtensions` 配置为第三方包补充缺失的依赖声明，解决幽灵依赖问题。*由于PnP模式彻底禁止访问幽灵依赖，这使得不规范的包难以使用，不利于推广*

### 4.x
+ 默认启用 `PnP`：强化零 `node_modules` 理念，但仍保留兼容模式选项。
+ 工作区协议优化：`workspace` 语法支持更灵活的跨包版本关联，简化 `monorepo` 内依赖管理。
+ 生态兼容性：对现代前端工具（如 Vite、Turbopack）的支持更完善，降低集成成本。

## pnpm
> 通过对 `Yarn` 的学习，了解了一个现代包管理工具需要具备的基本功能，实际上 `pnpm` 的发展历程也大同小异，但应该从最终表现的部分差异来看工具的区别

### Yarn 4 和 pnpm 10 共同点
+ 两者本质都是通过全局化包缓存来达到高复用的功能
+ 均默认禁止访问 幽灵依赖
+ 均对`monorepo`做了优化，即工作区
+ 各自有临时执行工具


### pnpm store 和 yarn PnP
+ `pnpm` 保留了虚拟 `node_modules`,对看源码更友好
+ `pnpm` 使用内容寻址存储 + 硬链接 + 符号链接的方式做指向
> 内容寻址是指`pnpm`的全局包会以哈希值标识，在项目中，使用硬链接的方式指向标识包。至于符合链接，则是解决包之间的依赖关系，用来构建虚拟依赖树以兼容
> `NodeJs` 嵌套寻找依赖包的逻辑，兼容性非常优秀。
+ 而`yarn PnP`使用的是路径映射的方式
> 把缓存路径和依赖关系都写到`.pnp.cjs` 中，运行时使用`PnP加载器`拦截`NodeJs`的路径处理。*直接拦截并替换路径，理论性能更好——路径映射解析可能在特定场景下略慢于 pnpm 的链接机制。*
+ `yarn PnP` 部分工具需要用到 `yarn的插件` 做兼容。