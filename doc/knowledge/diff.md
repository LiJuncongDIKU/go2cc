# diff 算法比较
:::tip TODO
💪 目前是概况描述，后续随着深入学习继续补充
:::

### 同层级比较
我们知道无论React还是Vue，使用虚拟节点的框架都必须对比新旧虚拟dom树的差异。但是两棵树的比较非常复杂，所以vue和react默认了两个逻辑：
- 如果节点类型发生变化时，会直接替换整个节点。
- 跨层级移动的时候会销毁重建。

在此前提下，diff算法专注于同层级节点的比较。

## Vue2: 双端比较 🔀
新旧队列的四个指针分别指向新旧节点的头、尾、头、尾。
```text
新：[A , B , C , D]
     ^           ^
旧：[E , A , C , D]
     ^           ^
```
1. 新前 - 旧前 : AE没有命中
2. 新后 - 旧后 : DD命中，复用并更新，指针向中间移动
   ```text
   [A , B , C , D]
    ^       ^
   [E , A , C , D]
    ^       ^
   ```
3. 新一轮比较，CC命中，复用并更新，指针向中间移动
   ```text
   [A , B , C , D]
    ^   ^
   [E , A , C , D]
    ^   ^
   ```
4. 新后 - 旧前 : BE没有命中
5. 新前 - 旧后 : AA命中，如果这一层没有命中，会拿新前A到整个旧队列中查找是否有相同节点。
6. 指针都到达中间（各自队列中，头指针大于尾指针）之后，可以得出旧队列中多余的节点（移除），新队列中多余的节点（创建）。
7. 在这个例子中，第一轮四个指针都没有命中，所以会拿 新前 到旧队列(这里会使用映射表)中查找是否有相同节点。A节点会被立刻搬运
   ```text
   另外的例子
   [A , B , C , D] 旧
    ^           ^
   [E , F , A , C] 新
    ^           ^
   ```
8. 也就是说最坏的情况就是每一轮四次指针对比都不命，相当于新前指针遍历了一次映射表，时间复杂度为O(n)
9. 重复这个过程能够最大程度得复用节点

## Vue3: 快速Diff
1. 预处理阶段：处理常规的场景
   - 双端比较头尾指针命中时快速分组
    ```text
     新：[A , B , C , D]
     旧：[A , B]
    ```
    或
    ```text
     新：[A , B , C , D]
     旧：[C , D]
    ```
  - 其他情况会进入到乱序映射处理中
2. 乱序映射处理阶段
   - 例如, 头尾都没有命中时，会从新节点查找旧索引
    ```text
     新：[A , B , C ，F , D ，E]
     旧：[B , C， D]
    ```
    A: 无旧索引 \
    B: 旧索引为1 \
    C: 旧索引为2 \
    F: 无旧索引 \
    D: 旧索引为3 \
    E: 无旧索引 \
    得出：最长递增子序列为[B , C , D]，他们被标记为稳定 \
    所以需要插入的节点为[A , F , E]
  - 虽然例子很简单，但是根据这个思路可以得出
    - 稳定节点
    - 需要插入的
    - 需要删除的
    - 需要移动的
3. 核心：最长递增子序列算法：TODO

## React: 极简单次遍历
例如： \[A,B,C,D,E,F\]
1. 构建旧队列映射：`{A:0,B:1,C:2,D:3,E:4,F:5}`
2. 遍历新队列，并维护一个 `lastPlacedIndex` 指针，决定操作
3. lastPlacedIndex 初始化为0。
   1. 当访问映射时，当前节点的旧索引大于lastPlacedIndex时，说明当前节点是稳定的，lastPlacedIndex更新。
   2. 当访问映射时，当前节点的旧索引小于lastPlacedIndex时，说明当前节点是需要移动的。lastPlacedIndex不变。
   3. 结论是：“右移偏好”

| 新队列            | 旧索引映射       | 需要移动的节点 | 场景效果|
|-------------------|------------------|----------------| ----------------|
| [B,C,A,D,E,F]     | [1,2,0,3,4,5]    | A              | :smile: |
| [B,E,A,C,D,F]     | [1,4,0,2,3,5]    | A,C,D          | :tired_face: |
| [F,A,B,C,D,E]     | [5,0,1,2,3,4]    | A,B,C,D,E      | :skull: |
