# 事件循环机制
这是个从JS单线程机制衍生出来的话题，为了实现异步操作，JS引入了事件循环机制。

```
┌─────────────────────────────────────────────────────────────┐
  浏览器/Node 环境                        
└───────────┬───────────────────────┬─────────────────────────┘
            │                       │
┌───────────▼─────────┐   ┌─────────▼───────────────────────┐
  调用栈 (Call Stack)       Web API/Node API（异步任务处理） 
  （同步代码/函数执行）       （定时器/网络请求/事件监听等）    
└───────────┬─────────┘   └─────────┬───────────────────────┘
            │                       │
            │ 同步代码执行完/异步任务触发 │
            │                       │
            ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
                     任务队列 (Task Queue)                    
  ┌───────────────────────┐  ┌─────────────────────────────┐  
    微任务队列 (Microtasks)    宏任务队列 (Macrotasks)      
    - Promise.then/catch      - setTimeout/setInterval      
    - async/await 底层        - DOM 事件回调                
    - queueMicrotask          - AJAX/fetch 网络回调         
    - process.nextTick(Node)  - setImmediate (Node)         
  └───────────┬───────────┘  └───────────┬─────────────────┘  
└──────────────┼───────────────────────────┼─────────────────────┘
               │                           │
               │ 微任务队列优先清空        │ 每次仅取一个宏任务执行
               ▼                           ▼
┌─────────────────────────────────────────────────────────────┐
                     事件循环 (Event Loop)                    
  核心规则：                                                 
  1. 执行调用栈中所有同步代码                                
  2. 清空微任务队列（所有微任务依次入栈执行，执行过程中新增的微任务也会执行） 
  3. 从宏任务队列取「一个」宏任务入栈执行                     
  4. 再次清空微任务队列（重复步骤2）                         
  5. 重复 3-4，直到所有任务执行完毕                          
└─────────────────────────────────────────────────────────────┘
```
简单例子
```js
<!--@include: ../../demo/loopEvent/loopEvent.js -->
```
### 常见的宏任务和微任务 🤖gemini
| 类别       | 任务名称                     | 描述 / 备注                                    |
| :--------- | :--------------------------- | :--------------------------------------------- |
| **宏任务** | `script` (整体代码)          | 整个 JS 文件的同步代码执行。                   |
|            | `setTimeout`                 | 延时触发的定时器。                             |
|            | `setInterval`                | 循环触发的定时器。                             |
|            | `setImmediate`               | 仅 Node.js 环境，在当前 Poll 阶段结束后触发。  |
|            | `I/O`                        | 读写文件、网络请求回调等。                     |
|            | `UI Rendering`               | 浏览器环境下的页面重绘与回流。                 |
|            | `MessageChannel`             | 用于跨线程/窗口通信的回调。                    |
| **微任务** | `Promise.then/catch/finally` | Promise 状态改变后的回调。                     |
|            | `process.nextTick`           | 仅 Node.js 环境，在当前阶段结束即刻触发。      |
|            | `MutationObserver`           | 监听 DOM 树变化的 API。                        |
|            | `queueMicrotask()`           | 现代浏览器提供的专门用于手动添加微任务的方法。 |